define(["underscore","app/task/script","./current_trial"],function(e,t,n){return function(i,s){var o=t.global,u=n();if(!i)throw new Error("There is an interaction without conditions!!");i=e.isArray(i)?i:[i],s=s||{};var a=!0;if(s.type=="begin"){var f=e.reduce(i,function(e,t){return e||t.type=="begin"},!1);if(!f)return!1}return e.each(i,function(t){var n,r,i=!0;switch(t.type){case"begin":s.type!=="begin"&&(i=!1);break;case"inputEquals":e.isArray(t.value)||(t.value=[t.value]),e.indexOf(t.value,s.handle)===-1&&(i=!1);break;case"inputEqualsTrial":s.handle!==u.data[t.property]&&(i=!1);break;case"inputEqualsStim":n={},t.handle&&(n.handle=t.handle),n[t.property]=s.handle,r=u._stimulus_collection.whereData(n),r.length===0&&(i=!1);break;case"inputEqualsGlobal":if(typeof t.property=="undefined")throw new Error('inputEqualsGlobal requires both "property" to be defined');s.handle!==o[t.property]&&(i=!1);break;case"trialEquals":if(typeof t.property=="undefined"||typeof t.value=="undefined")throw new Error('trialEquals requires both "property" and "value" to be defined');t.value!==u.data[t.property]&&(i=!1);break;case"globalEquals":if(typeof t.property=="undefined"||typeof t.value=="undefined")throw new Error('globalEquals requires both "property" and "value" to be defined');t.value!==o[t.property]&&(i=!1);break;case"globalEqualsTrial":if(typeof t.globalProp=="undefined"||typeof t.trialProp=="undefined")throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');o[t.globalProp]!==u.data[t.trialProp]&&(i=!1);break;case"globalEqualsStim":if(typeof t.globalProp=="undefined"||typeof t.stimProp=="undefined")throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');n={},t.handle&&(n.handle=t.handle),n[t.stimProp]=o[t.globalProp],r=u._stimulus_collection.whereData(n),r.length===0&&(i=!1);break;case"function":t.value.apply(u,[u,s])||(i=!1);break;default:throw new Error("Unknown condition type: "+t.type)}a=a&&(t.negate?!i:i)}),a}});