define(["require","jquery","underscore","utils/pubsub","utils/interface/interface","app/stimulus/stimulus_collection","./interactions","./current_trial","../inflator","app/task/main_view"],function(e){var t=e("jquery"),n=e("underscore"),r=e("utils/pubsub"),i=e("utils/interface/interface"),s=e("app/stimulus/stimulus_collection"),o=e("./interactions"),u=e("./current_trial"),a=e("../inflator"),f=e("app/task/main_view"),l=0,c=function(e){var r=a(e,"trial");n.extend(this,r),this.data||(this.data={}),this._source=r,this._id=n.uniqueId("trial_"),this.counter=l++;if(!this.interactions)throw new Error("Interactions not defined");this._layout_collection=new s(this.layout||[],{trial:this}),this._stimulus_collection=new s(this.stimuli||[],{trial:this}),this._pubsubStack=[],this._next=["next",{}],this.deferred=t.Deferred()};return n.extend(c.prototype,{activate:function(){var e=this;return u(this),this._layout_collection.display_all(),r.subscribe("trial:end",this._pubsubStack,n.bind(this.deactivate,this)),r.subscribe("trial:setAttr",this._pubsubStack,function(t,r){n.isFunction(t)?t.apply(e,[e.data,r]):n.extend(e.data,t)}),r.subscribe("trial:setInput",this._pubsubStack,function(e){i.add(e)}),r.subscribe("trial:removeInput",this._pubsubStack,function(e){i.remove(e)}),r.subscribe("trial:goto",this._pubsubStack,function(t){e._next=[t.destination,t.properties||{}]}),i.add(this.input||[]),this._stimulus_collection.activate(),i.resetTimer(),o.activate(this.interactions),this.deferred.promise()},deactivate:function(){var e=this;i.destroy(),this._stimulus_collection.disable(),o.disable(),n.each(this._pubsubStack,function(e){r.unsubscribe(e)}),this._pubsubStack=[],u(undefined),document.all&&!document.addEventListener?setTimeout(function(){f.empty(),e.deferred.resolve(e._next[0],e._next[1])},1):(f.empty(),e.deferred.resolve(e._next[0],e._next[1]))},name:function(){return this.data.alias?this.data.alias:this.inherit&&this.inherit.set?this.inherit.set:!1}}),c});