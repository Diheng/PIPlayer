define(["underscore"],function(e){var t=function(n,r){var i=[];return e.each(n,function(n){var s=e.isObject(n)?n.mixer:undefined,o,u,a;switch(s){case"random":o=e.shuffle(t(n.data,!0)),u=r?o:t(o),i=i.concat(u);break;case"weightedRandom":var f=e.reduce(n.weights,function(e,t){return e+t}),l=Math.random()*f,c=0;for(a=0;a<n.data.length;a++){c+=n.weights[a],c=+c.toFixed(3);if(l<=c){o=[n.data[a]];break}}u=r?o:t(o),i=i.concat(u);break;case"choose":o=e.chain(n.data).shuffle().first(n.n?n.n:1).value(),u=r?o:t(o),i=i.concat(u);break;case"repeat":o=t(n.data,!0);for(a=0;a<n.times;a++)u=r?o:t(o),i=i.concat(u);break;case"wrapper":r?i.push(n):i=i.concat(t(n.data));break;case undefined:i.push(n);break;default:throw new Error("Unknown wrapper "+s)}}),i};return t});